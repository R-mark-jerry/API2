<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myruoyi.system.mapper.SysUserMapper">

    <resultMap type="SysUser" id="SysUserResult">
        <id     property="userId"       column="user_id"      />
        <result property="userName"     column="user_name"     />
        <result property="nickName"     column="nick_name"     />
        <result property="userType"     column="user_type"     />
        <result property="email"         column="email"          />
        <result property="phonenumber"   column="phonenumber"    />
        <result property="sex"           column="sex"            />
        <result property="avatar"        column="avatar"         />
        <result property="password"      column="password"       />
        <result property="status"        column="status"         />
        <result property="loginIp"       column="login_ip"       />
        <result property="loginDate"     column="login_date"     />
        <result property="createBy"      column="create_by"      />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"      column="update_by"      />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"        column="remark"         />
        <result property="deleted"       column="deleted"        />
    </resultMap>

    <select id="selectUserByUserName" parameterType="String" resultMap="SysUserResult">
        <include refid="selectUserVo"/>
        where u.user_name = #{userName} and u.deleted = 0
    </select>

    <select id="selectUserById" parameterType="Long" resultMap="SysUserResult">
        <include refid="selectUserVo"/>
        where u.user_id = #{userId} and u.deleted = 0
    </select>

    <select id="selectPermissionsByUserId" parameterType="Long" resultType="String">
        select distinct m.perms
        from sys_user_role ur
                 left join sys_role r on r.role_id = ur.role_id
                 left join sys_role_menu rm on r.role_id = rm.role_id
                 left join sys_menu m on m.menu_id = rm.menu_id
        where ur.user_id = #{userId}
          and r.status = '0'
          and m.status = '0'
    </select>

    <select id="selectRolesByUserId" parameterType="Long" resultType="String">
        select distinct r.role_key
        from sys_user_role ur
                 left join sys_role r on r.role_id = ur.role_id
        where ur.user_id = #{userId}
          and r.status = '0'
    </select>

    <select id="selectDeptNameByUserId" parameterType="Long" resultType="String">
        select d.dept_name
        from sys_dept d
        where d.dept_id = (select dept_id from sys_user where user_id = #{userId})
          and d.deleted = 0
        limit 1
    </select>

    <sql id="selectUserVo">
        select u.user_id,
               u.user_name,
               u.nick_name,
               u.user_type,
               u.email,
               u.phonenumber,
               u.sex,
               u.avatar,
               u.password,
               u.status,
               u.login_ip,
               u.login_date,
               u.create_by,
               u.create_time,
               u.update_by,
               u.update_time,
               u.remark,
               u.deleted
        from sys_user u
    </sql>

    <select id="selectPage" parameterType="com.baomidou.mybatisplus.extension.plugins.pagination.Page" resultMap="SysUserResult">
        <include refid="selectUserVo"/>
        <where>
            u.deleted = 0
            <if test="userName != null and userName != ''">
                and u.user_name like concat('%', #{userName}, '%')
            </if>
            <if test="phonenumber != null and phonenumber != ''">
                and u.phonenumber like concat('%', #{phonenumber}, '%')
            </if>
            <if test="status != null and status != ''">
                and u.status = #{status}
            </if>
        </where>
        order by u.create_time desc
    </select>

</mapper>