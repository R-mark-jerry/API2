<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myruoyi.api.mapper.ApiStatisticsMapper">
    
    <resultMap type="ApiStatistics" id="ApiStatisticsResult">
        <result property="statId"           column="stat_id"           />
        <result property="apiId"            column="api_id"            />
        <result property="apiCode"          column="api_code"          />
        <result property="statDate"          column="stat_date"          />
        <result property="totalCalls"        column="total_calls"        />
        <result property="successCalls"      column="success_calls"      />
        <result property="failCalls"         column="fail_calls"         />
        <result property="avgResponseTime"    column="avg_response_time"    />
        <result property="maxResponseTime"    column="max_response_time"    />
        <result property="minResponseTime"    column="min_response_time"    />
        <result property="createTime"         column="create_time"         />
        <result property="updateTime"         column="update_time"         />
        <result property="apiName"          column="api_name"          />
    </resultMap>

    <sql id="selectApiStatisticsVo">
        select s.stat_id, s.api_id, s.api_code, s.stat_date, s.total_calls, s.success_calls, s.fail_calls,
               s.avg_response_time, s.max_response_time, s.min_response_time, s.create_time, s.update_time,
               i.api_name
        from api_statistics s
        left join api_info i on s.api_id = i.api_id
    </sql>

    <select id="selectStatisticsByApiId" parameterType="Long" resultMap="ApiStatisticsResult">
        <include refid="selectApiStatisticsVo"/>
        where s.api_id = #{apiId}
        order by s.stat_date desc
    </select>

    <select id="selectStatisticsByDateRange" parameterType="Map" resultMap="ApiStatisticsResult">
        <include refid="selectApiStatisticsVo"/>
        where s.stat_date between #{startDate} and #{endDate}
        order by s.stat_date desc
    </select>

    <select id="selectStatisticsByApiIdAndDate" parameterType="Map" resultMap="ApiStatisticsResult">
        <include refid="selectApiStatisticsVo"/>
        where s.api_id = #{apiId} and s.stat_date = #{statDate}
    </select>

    <insert id="generateApiStatistics" parameterType="java.time.LocalDate">
        insert into api_statistics (api_id, api_code, stat_date, total_calls, success_calls, fail_calls, 
                                     avg_response_time, max_response_time, min_response_time, create_time)
        select l.api_id, l.api_code, #{statDate}, 
               count(1), 
               sum(case when l.call_result = '0' then 1 else 0 end),
               sum(case when l.call_result = '1' then 1 else 0 end),
               avg(case when l.call_result = '0' then l.response_time else null end),
               max(case when l.call_result = '0' then l.response_time else null end),
               min(case when l.call_result = '0' then l.response_time else null end),
               now()
        from api_call_log l
        where date(l.call_time) = #{statDate}
        group by l.api_id, l.api_code
    </insert>

</mapper>